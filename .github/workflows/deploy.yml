name: Deploy to Server

on:
  push:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Create deployment archive
      run: |
        echo "=== 检查本地目录结构 ==="
        ls -la
        echo "=== backend 目录内容 ==="
        ls -la backend/
        echo "=== 创建压缩包 ==="
        tar -czvf deploy.tar.gz backend/ frontend/ data/
        echo "=== 压缩包信息 ==="
        ls -lh deploy.tar.gz
        echo "=== 验证压缩包内容 ==="
        tar -tzf deploy.tar.gz | head -20
    
    - name: Upload to server
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        port: 22
        source: "deploy.tar.gz"
        target: "/tmp/"
        
    - name: Extract and deploy
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        port: 22
        timeout: 300s
        command_timeout: 30m
        script: |
            set -e

            echo "=== 开始部署 ==="
            PROJECT_DIR="$HOME/IoT_System"

            # 1. 准备目录
            echo "=== 准备项目目录 ==="
            rm -rf $PROJECT_DIR
            mkdir -p $PROJECT_DIR

            # 2. 解压
            echo "=== 解压文件 ==="
            if [ -f /tmp/deploy.tar.gz ]; then
                tar -xzf /tmp/deploy.tar.gz -C $PROJECT_DIR/
                rm -f /tmp/deploy.tar.gz
            else
                echo "ERROR: 压缩包不存在"
                exit 1
            fi

            # 3. 安装依赖
            echo "=== 检查并安装 Python 依赖 ==="
            cd $PROJECT_DIR/backend
            # 使用 --no-cache-dir 减少磁盘占用，|| true 防止因权限警告导致中断
            pip3 install --user -r requirements.txt || pip3 install --user flask flask-cors paho-mqtt pandas numpy scikit-learn websockets || true

            # 4. 停止旧服务 (重点优化：不再因为进程不存在而报错)
            echo "=== 停止旧服务 ==="
            # 使用 pkill -f 匹配命令行，并使用 || true 忽略“进程不存在”的错误
            pkill -f "python3.*subscribe.py" || true
            pkill -f "python3.*publish.py" || true
            pkill -f "python3.*data_address.py" || true
            pkill -f "python3.*app.py" || true
            sleep 2

            # 5. 启动新服务 (重点优化：使用 disown 确保进程在后台稳固运行)
            echo "=== 启动服务 ==="
            # 确保在 backend 目录下启动，或者使用绝对路径
            cd $PROJECT_DIR/backend

            nohup python3 subscribe.py > subscribe.log 2>&1 &
            disown
            nohup python3 publish.py > publish.log 2>&1 &
            disown
            nohup python3 data_address.py > analysis.log 2>&1 &
            disown
            nohup python3 app.py > app.log 2>&1 &
            disown

            echo "=== 部署完成，检查运行状态 ==="
            sleep 3
            ps aux | grep python3 | grep -E "subscribe|publish|data_address|app" || echo "警告：未发现运行中的服务"

            # 打印最后几行日志看看有没有启动报错
            echo "=== 最近日志摘要 ==="
            tail -n 5 *.log || true