name: Deploy to Server

on:
  push:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Create deployment archive
      run: |
        tar -czf deploy.tar.gz backend/ frontend/ data/
        ls -lh deploy.tar.gz
    
    - name: Upload and extract on server
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        port: 22
        source: "deploy.tar.gz"
        target: "~/"
        
    - name: Extract and install dependencies
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        port: 22
        script: |
          set -e
          
          echo "=== 开始部署 ==="
          echo "当前用户: $(whoami)"
          
          # 解压文件
          cd ~
          tar -xzf deploy.tar.gz -C ~/IoT_System/ 2>/dev/null || (mkdir -p ~/IoT_System && tar -xzf deploy.tar.gz -C ~/IoT_System/)
          rm -f deploy.tar.gz
          
          PROJECT_DIR="$HOME/IoT_System"
          cd $PROJECT_DIR
          
          echo "=== 当前目录结构 ==="
          ls -la
          
          # 检查 backend 目录
          if [ ! -d "backend" ]; then
            echo "ERROR: backend 目录不存在"
            ls -la
            exit 1
          fi
          echo "✓ backend 目录存在"
          
          # 安装 Python 依赖
          echo "=== 安装 Python 依赖 ==="
          cd backend
          if [ -f "requirements.txt" ]; then
            echo "安装 requirements.txt 中的依赖..."
            pip3 install -r requirements.txt
          else
            echo "安装基础依赖..."
            pip3 install flask flask-cors paho-mqtt pandas numpy scikit-learn websockets
          fi
          
          # 安装前端依赖
          cd $PROJECT_DIR
          if [ -d "frontend" ]; then
            echo "=== 安装前端依赖 ==="
            cd frontend
            npm install || echo "前端依赖安装失败，继续部署..."
          fi
          
          # 停止旧服务
          echo "=== 停止旧服务 ==="
          pkill -f "python.*publish.py" || true
          pkill -f "python.*subscribe.py" || true
          pkill -f "python.*data_address.py" || true
          pkill -f "python.*app.py" || true
          sleep 5
          
          # 启动新服务
          echo "=== 启动服务 ==="
          cd $PROJECT_DIR
          nohup python3 backend/subscribe.py > backend/subscribe.log 2>&1 &
          nohup python3 backend/publish.py > backend/publish.log 2>&1 &
          nohup python3 backend/data_address.py > backend/analysis.log 2>&1 &
          nohup python3 backend/app.py > backend/app.log 2>&1 &
          
          echo "=== 部署完成 ==="
          echo "当前运行的 Python 服务:"
          ps aux | grep python | grep -v grep || echo "没有找到运行中的服务"
