name: Deploy to Server

on:
  push:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Create deployment archive
      run: |
        echo "=== 检查本地目录结构 ==="
        ls -la
        echo "=== backend 目录内容 ==="
        ls -la backend/
        echo "=== 创建压缩包 ==="
        tar -czvf deploy.tar.gz backend/ frontend/ data/
        echo "=== 压缩包信息 ==="
        ls -lh deploy.tar.gz
        echo "=== 验证压缩包内容 ==="
        tar -tzf deploy.tar.gz | head -20
    
    - name: Upload to server
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        port: 22
        source: "deploy.tar.gz"
        target: "/tmp/"
        
    - name: Extract and deploy
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        port: 22
        timeout: 300s
        command_timeout: 30m
        script: |
            set -e

            echo "=== 开始部署 ==="
            PROJECT_DIR="$HOME/IoT_System"

            # 1. 准备目录
            echo "=== 准备项目目录 ==="
            rm -rf $PROJECT_DIR
            mkdir -p $PROJECT_DIR

            # 2. 解压
            echo "=== 解压文件 ==="
            if [ -f /tmp/deploy.tar.gz ]; then
                tar -xzf /tmp/deploy.tar.gz -C $PROJECT_DIR/
                rm -f /tmp/deploy.tar.gz
            else
                echo "ERROR: 压缩包不存在"
                exit 1
            fi

            # 3. 安装依赖
            echo "=== 检查并安装 Python 依赖 ==="
            cd $PROJECT_DIR/backend
            pip3 install --user -r requirements.txt || true

            # 4. 停止旧服务 (使用 [ ] 技巧防止进程自杀)
            echo "=== 停止旧服务 ==="
            # [s]ubscribe 会匹配 "subscribe"，但 pkill 自己的命令行里是 "[s]ubscribe"，不匹配正则
            pkill -f "python3.*[s]ubscribe.py" || true
            pkill -f "python3.*[p]ublish.py" || true
            pkill -f "python3.*[d]ata_address.py" || true
            pkill -f "python3.*[a]pp.py" || true
            sleep 2

            # 5. 启动新服务
            echo "=== 启动服务 ==="
            cd $PROJECT_DIR/backend

            # 依次启动并记录 PID 
            nohup python3 subscribe.py > subscribe.log 2>&1 &
            echo $! > subscribe.pid
            nohup python3 publish.py > publish.log 2>&1 &
            echo $! > publish.pid
            nohup python3 data_address.py > analysis.log 2>&1 &
            echo $! > analysis.pid
            nohup python3 app.py > app.log 2>&1 &
            echo $! > app.pid

            disown -a

            echo "=== 部署完成，检查运行状态 ==="
            sleep 5
            ps aux | grep python3 | grep -E "subscribe|publish|data_address|app" || echo "警告：未发现运行中的服务"

            # 检查日志是否有立即报错
            echo "=== 启动日志自检 ==="
            for log in *.log; do
                echo "--- $log 尾部内容 ---"
                tail -n 5 "$log"
            done