name: Deploy to Server

on:
  push:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Create deployment archive
      run: |
        echo "=== 检查本地目录结构 ==="
        ls -la
        echo "=== backend 目录内容 ==="
        ls -la backend/
        echo "=== 创建压缩包 ==="
        tar -czvf deploy.tar.gz backend/ frontend/ data/
        echo "=== 压缩包信息 ==="
        ls -lh deploy.tar.gz
        echo "=== 验证压缩包内容 ==="
        tar -tzf deploy.tar.gz | head -20
    
    - name: Upload to server
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        port: 22
        source: "deploy.tar.gz"
        target: "/tmp/"
        
    - name: Extract and deploy
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        port: 22
        timeout: 300s
        command_timeout: 30m
        script: |
            echo "=== 开始部署 ==="
            PROJECT_DIR="$HOME/IoT_System"

            # 1. 准备目录与解压
            echo "=== 准备项目目录并解压 ==="
            if [ ! -f /tmp/deploy.tar.gz ]; then
                echo "ERROR: /tmp/deploy.tar.gz 不存在"
                exit 1
            fi
            rm -rf $PROJECT_DIR
            mkdir -p $PROJECT_DIR
            tar -xzf /tmp/deploy.tar.gz -C $PROJECT_DIR/
            rm -f /tmp/deploy.tar.gz

            # 2. 安装依赖
            echo "=== 安装后端依赖 ==="
            cd $PROJECT_DIR/backend
            pip3 install --user -r requirements.txt || true
            
            # 安装前端依赖并构建（如果 npm 存在）
            cd $PROJECT_DIR
            if [ -d "frontend" ]; then
              if command -v npm &> /dev/null; then
                echo "=== 安装前端依赖并构建 ==="
                cd frontend
                npm install || echo "前端依赖安装失败，继续部署..."
                npm run build || echo "前端构建失败，继续部署..."
              else
                echo "npm 未安装，跳过前端构建"
              fi
            fi

            # 3. 精确清理旧进程 (不再使用危险的 pkill)
            echo "=== 停止旧服务 ==="
            # 定义我们要清理的脚本名称
            for script_name in "subscribe.py" "publish.py" "data_address.py" "app.py"; do
                echo "正在检查 $script_name..."
                # 查找进程ID，排除 grep 自身，排除当前 shell 脚本
                pids=$(ps -ef | grep "$script_name" | grep -v grep | awk '{print $2}')
                if [ -n "$pids" ]; then
                    echo "发现旧进程 $script_name (PIDs: $pids)，正在终止..."
                    kill -9 $pids 2>/dev/null || true
                else
                    echo "$script_name 未在运行"
                fi
            done
            sleep 2

            # 4. 启动新服务
            echo "=== 启动新服务 ==="
            cd $PROJECT_DIR/backend

            # 使用 nohup 启动，并将输出重定向
            # 添加 stdbuf -oL 强制 Python 使用行缓冲，确保日志实时写入
            nohup python3 -u subscribe.py > subscribe.log 2>&1 &
            nohup python3 -u publish.py > publish.log 2>&1 &
            nohup python3 -u data_address.py > analysis.log 2>&1 &
            nohup python3 -u app.py > app.log 2>&1 &
                        
            # 启动前端服务（使用 Python HTTP 服务器提供静态文件）
            cd $PROJECT_DIR
            if [ -d "frontend/dist" ]; then
              echo "=== 启动前端 HTTP 服务器 ==="
              cd frontend/dist
              nohup python3 -m http.server 8080 > frontend_server.log 2>&1 &
            elif command -v npm &> /dev/null && [ -d "frontend" ]; then
              echo "=== 启动前端开发服务器 ==="
              cd frontend
              nohup npm run dev -- --host 0.0.0.0 --port 5173 > frontend.log 2>&1 &
            else
              echo "前端未构建，跳过前端服务启动"
            fi
                        
            # 关键：稍微等待并确保进程已经脱离当前 shell
            sleep 3
            disown -a

            echo "=== 部署完成，当前运行状态 ==="
            ps -ef | grep python3 | grep -E "subscribe|publish|data_address|app" | grep -v grep || echo "警告：未发现运行中的服务"

            echo "=== 最近日志摘要 ==="
            tail -n 10 *.log || true