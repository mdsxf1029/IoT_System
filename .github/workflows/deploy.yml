name: Deploy to Server

on:
  push:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    # --- 步骤 1: 在 GitHub 侧打包前端 (稳如泰山) ---
    - name: Install Frontend and Build
      run: |
        cd frontend
        npm install
        npm run build  # 这一步会生成 dist 文件夹
        cd ..

    - name: Create deployment archive
      run: |
        # 打包后端、前端构建产物和数据目录，包含 SPA 服务器脚本和主服务文件
        tar -czvf deploy.tar.gz backend/ frontend/dist/ frontend/spa_server.py data/

    - name: Upload to server
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        port: 22
        source: "deploy.tar.gz"
        target: "/tmp/"
        
    - name: Extract and deploy
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        port: 22
        timeout: 300s
        script: |
            echo "=== 开始部署 ==="
            PROJECT_DIR="$HOME/IoT_System"

            # 1. 准备目录与解压
            rm -rf $PROJECT_DIR
            mkdir -p $PROJECT_DIR
            tar -xzf /tmp/deploy.tar.gz -C $PROJECT_DIR/
            rm -f /tmp/deploy.tar.gz

            # 2. 安装后端依赖
            cd $PROJECT_DIR/backend
            pip3 install --user -r requirements.txt || true
            
            # 3. 彻底清理旧进程 (包括后端 Python 和前端 Server)
            echo "=== 停止旧服务 ==="
            # 清理后端
            for name in "main_service.py" "publish.py" "data_address.py" "app.py" "subscribe.py" "combined_service.py"; do
                pids=$(ps -ef | grep "$name" | grep -v grep | awk '{print $2}')
                [ -n "$pids" ] && kill -9 $pids || true
            done
            # 清理前端服务器 (端口 5173)
            fuser -k 5173/tcp || true

            # 4. 启动后端服务
            echo "=== 启动后端服务 ==="
            cd $PROJECT_DIR/backend
            nohup python3 -u main_service.py > main_service.log 2>&1 &
            nohup python3 -u publish.py > publish.log 2>&1 &
            nohup python3 -u app.py > app.log 2>&1 &
            
            # 5. 启动前端服务 (支持 SPA 路由的 5173 端口)
            echo "=== 启动前端服务 (Port: 5173) ==="
            if [ -d "$PROJECT_DIR/frontend/dist" ]; then
                cd $PROJECT_DIR/frontend
                # 使用支持 SPA 路由的服务器
                nohup python3 spa_server.py > frontend.log 2>&1 &
            else
                echo "ERROR: dist 目录不存在，请检查构建步骤"
            fi
                        
            sleep 3
            disown -a
            echo "=== 部署完成 ==="
            netstat -tulpn | grep -E "5000|5173" || echo "未发现端口监听"
