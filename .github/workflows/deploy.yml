name: Deploy to Server

on:
  push:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Create deployment archive
      run: |
        echo "=== 检查本地目录结构 ==="
        ls -la
        echo "=== backend 目录内容 ==="
        ls -la backend/
        echo "=== 创建压缩包 ==="
        tar -czvf deploy.tar.gz backend/ frontend/ data/
        echo "=== 压缩包信息 ==="
        ls -lh deploy.tar.gz
        echo "=== 验证压缩包内容 ==="
        tar -tzf deploy.tar.gz | head -20
    
    - name: Upload to server
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        port: 22
        source: "deploy.tar.gz"
        target: "/tmp/"
        
    - name: Extract and deploy
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        port: 22
        timeout: 300s
        command_timeout: 30m
        script: |
          set -e
          
          echo "=== 开始部署 ==="
          echo "当前用户: $(whoami)"
          echo "HOME目录: $HOME"
          
          # 检查上传的文件
          echo "=== 检查上传的文件 ==="
          ls -la /tmp/deploy.tar.gz || (echo "ERROR: 压缩包不存在" && exit 1)
          
          # 检查压缩包内容
          echo "=== 压缩包内容 ==="
          tar -tzf /tmp/deploy.tar.gz | head -10
          
          # 创建项目目录（清理旧目录）
          echo "=== 准备项目目录 ==="
          rm -rf $HOME/IoT_System
          mkdir -p $HOME/IoT_System
          
          # 解压文件
          echo "=== 解压文件 ==="
          tar -xzf /tmp/deploy.tar.gz -C $HOME/IoT_System/
          rm -f /tmp/deploy.tar.gz
          
          # 检查解压结果
          echo "=== 解压后的目录结构 ==="
          ls -la $HOME/IoT_System/
          
          PROJECT_DIR="$HOME/IoT_System"
          cd $PROJECT_DIR
          
          # 检查 backend 目录
          if [ ! -d "backend" ]; then
            echo "ERROR: backend 目录不存在"
            echo "当前目录内容:"
            ls -la
            exit 1
          fi
          echo "✓ backend 目录存在"
          ls -la backend/
          
          # 安装 Python 依赖
          echo "=== 安装 Python 依赖 ==="
          cd backend
          if [ -f "requirements.txt" ]; then
            pip3 install -r requirements.txt
          else
            pip3 install flask flask-cors paho-mqtt pandas numpy scikit-learn websockets
          fi
          
          # 安装前端依赖（如果 npm 存在）
          cd $PROJECT_DIR
          if [ -d "frontend" ]; then
            if command -v npm &> /dev/null; then
              echo "=== 安装前端依赖 ==="
              cd frontend
              npm install || echo "前端依赖安装失败，继续部署..."
            else
              echo "npm 未安装，跳过前端依赖安装"
            fi
          fi
          
          # 停止旧服务（使用更安全的方式）
          echo "=== 停止旧服务 ==="
          cd $PROJECT_DIR
          
          # 使用 PID 文件或直接查找进程
          for script in publish.py subscribe.py data_address.py app.py; do
            pid=$(pgrep -f "python3.*$script" 2>/dev/null || true)
            if [ -n "$pid" ]; then
              echo "停止 $script (PID: $pid)"
              kill $pid 2>/dev/null || true
            fi
          done
          
          sleep 2
          
          # 启动新服务
          echo "=== 启动服务 ==="
          cd $PROJECT_DIR
          nohup python3 backend/subscribe.py > backend/subscribe.log 2>&1 &
          nohup python3 backend/publish.py > backend/publish.log 2>&1 &
          nohup python3 backend/data_address.py > backend/analysis.log 2>&1 &
          nohup python3 backend/app.py > backend/app.log 2>&1 &
          
          echo "=== 部署完成 ==="
          ps aux | grep python | grep -v grep || echo "没有运行中的服务"
